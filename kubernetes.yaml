---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: database-visualization
    labels:
        app: database-visualization
spec:
    replicas: 1
    revisionHistoryLimit: 5
    selector:
        matchLabels:
            app: database-visualization
    strategy: 
        type: RollingUpdate
        rollingUpdate:
            maxSurge: 1
            maxUnavailable: 33%
    template:
        metadata:
            labels:
                app: database-visualization
        spec:
            containers:
                - name: database-visualization-container
                  image: alexandrefigueired0/database-visualization-container:latest
                  ports:
                      - containerPort: 50051
                  resources:
                      requests:
                          memory: "48Mi"
                          cpu: "20m"
                      limits:
                          memory: "64Mi"
                          cpu: "40m"
---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: database-ranking
    labels:
        app: database-ranking
spec:
    replicas: 1
    revisionHistoryLimit: 5
    selector:
        matchLabels:
            app: database-ranking
    strategy: 
        type: RollingUpdate
        rollingUpdate:
            maxSurge: 1
            maxUnavailable: 33%
    template:
        metadata:
            labels:
                app: database-ranking
        spec:
            containers:
                - name: database-ranking-container
                  image: alexandrefigueired0/database-ranking-container:latest
                  ports:
                      - containerPort: 50052
                  resources:
                      requests:
                          memory: "48Mi"
                          cpu: "20m"
                      limits:
                          memory: "64Mi"
                          cpu: "40m"
---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: forecast
    labels:
        app: forecast
spec:
    replicas: 1
    revisionHistoryLimit: 5
    selector:
        matchLabels:
            app: forecast
    strategy: 
        type: RollingUpdate
        rollingUpdate:
            maxSurge: 1
            maxUnavailable: 33%
    template:
        metadata:
            labels:
                app: forecast
        spec:
            containers:
                - name: forecast-container
                  image: alexandrefigueired0/forecast-container:latest
                  ports:
                      - containerPort: 8080
                  resources:
                      requests:
                          memory: "512Mi"
                          cpu: "500m"
                      limits:
                          memory: "768Mi"
                          cpu: "750m"
                  readinessProbe:
                      httpGet:
                          path: /api/forecast/liveness-check
                          port: 8080
                      initialDelaySeconds: 120
                      periodSeconds: 10
                  livenessProbe:
                      httpGet:
                          path: /api/forecast/liveness-check
                          port: 8080
                      periodSeconds: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: management
    labels:
        app: management
spec:
    replicas: 1
    revisionHistoryLimit: 5
    selector:
        matchLabels:
            app: management
    strategy: 
        type: RollingUpdate
        rollingUpdate:
            maxSurge: 1
            maxUnavailable: 33%
    template:
        metadata:
            labels:
                app: management
        spec:
            containers:
                - name: management-container
                  image: alexandrefigueired0/management-container:latest
                  env:
                      - name: DATABASE_VISUALIZATION_HOST
                        valueFrom:
                            secretKeyRef:
                                name: secret-prod
                                key: DATABASE_VISUALIZATION_HOST
                      - name: DATABASE_RANKING_HOST
                        valueFrom:
                            secretKeyRef:
                                name: secret-prod
                                key: DATABASE_RANKING_HOST
                      - name: APP_SECRET_KEY
                        valueFrom:
                            secretKeyRef:
                                name: secret-prod
                                key: APP_SECRET_KEY
                      - name: AUTH0_DOMAIN
                        valueFrom:
                            secretKeyRef:
                                name: secret-prod
                                key: AUTH0_DOMAIN
                      - name: AUTH0_CLIENT_ID
                        valueFrom:
                            secretKeyRef:
                                name: secret-prod
                                key: AUTH0_CLIENT_ID
                      - name: AUTH0_CLIENT_SECRET
                        valueFrom:
                            secretKeyRef:
                                name: secret-prod
                                key: AUTH0_CLIENT_SECRET
                  ports:
                      - containerPort: 8081
                  resources:
                      requests:
                          memory: "48Mi"
                          cpu: "100m"
                      limits:
                          memory: "64Mi"
                          cpu: "200m"
                  livenessProbe:
                      httpGet:
                          path: /api/management/liveness-check
                          port: 8081
                      initialDelaySeconds: 60
                      periodSeconds: 5
                  volumeMounts:
                      - name: secrets
                        mountPath: "/secrets"
                        readOnly: true
            volumes:
                - name: secrets
                  secret:
                      secretName: secret-prod
---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: ranking
    labels:
        app: ranking
spec:
    replicas: 1
    revisionHistoryLimit: 5
    selector:
        matchLabels:
            app: ranking
    strategy: 
        type: RollingUpdate
        rollingUpdate:
            maxSurge: 1
            maxUnavailable: 33%
    template:
        metadata:
            labels:
                app: ranking
        spec:
            containers:
                - name: ranking-container
                  image: alexandrefigueired0/ranking-container:latest
                  env:
                      - name: DATABASE_RANKING_HOST
                        valueFrom:
                            secretKeyRef:
                                name: secret-prod
                                key: DATABASE_RANKING_HOST
                  ports:
                      - containerPort: 8082
                  resources:
                      requests:
                          memory: "64Mi" 
                          cpu: "20m"
                      limits:
                          memory: "128Mi"
                          cpu: "40m"
                  livenessProbe:
                      httpGet:
                          path: /api/ranking/liveness-check
                          port: 8082
                      initialDelaySeconds: 60
                      periodSeconds: 5
                  volumeMounts:
                      - name: secrets
                        mountPath: "/secrets"
                        readOnly: true
            volumes:
                - name: secrets
                  secret:
                      secretName: secret-prod
---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: recommendations
    labels:
        app: recommendations
spec:
    replicas: 1
    revisionHistoryLimit: 5
    selector:
        matchLabels:
            app: recommendations
    strategy: 
        type: RollingUpdate
        rollingUpdate:
            maxSurge: 1
            maxUnavailable: 33%
    template:
        metadata:
            labels:
                app: recommendations
        spec:
            containers:
                - name: recommendations-container
                  image: alexandrefigueired0/recommendations-container:latest
                  ports:
                      - containerPort: 8083
                  env:
                      - name: APP_SECRET_KEY
                        valueFrom:
                            secretKeyRef:
                                name: secret-prod
                                key: APP_SECRET_KEY
                      - name: AUTH0_DOMAIN
                        valueFrom:
                            secretKeyRef:
                                name: secret-prod
                                key: AUTH0_DOMAIN
                      - name: AUTH0_CLIENT_ID
                        valueFrom:
                            secretKeyRef:
                                name: secret-prod
                                key: AUTH0_CLIENT_ID
                      - name: AUTH0_CLIENT_SECRET
                        valueFrom:
                            secretKeyRef:
                                name: secret-prod
                                key: AUTH0_CLIENT_SECRET
                  resources:
                      requests:
                          memory: "512Mi"
                          cpu: "500m"
                      limits:
                          memory: "768Mi"
                          cpu: "750m"
                  readinessProbe:
                      httpGet:
                          path: /api/recommendations/liveness-check
                          port: 8083
                      initialDelaySeconds: 120
                      periodSeconds: 10
                  livenessProbe:
                      httpGet:
                          path: /api/recommendations/liveness-check
                          port: 8083
                      periodSeconds: 80
                  volumeMounts:
                      - name: secrets
                        mountPath: "/secrets"
                        readOnly: true
            volumes:
                - name: secrets
                  secret:
                      secretName: secret-prod
---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: visualization
    labels:
        app: visualization
spec:
    replicas: 1
    revisionHistoryLimit: 5
    selector:
        matchLabels:
            app: visualization
    strategy: 
        type: RollingUpdate
        rollingUpdate:
            maxSurge: 1
            maxUnavailable: 33%
    template:
        metadata:
            labels:
                app: visualization
        spec:
            containers:
                - name: visualization-container
                  image: alexandrefigueired0/visualization-container:latest
                  env:
                      - name: DATABASE_VISUALIZATION_HOST
                        valueFrom:
                            secretKeyRef:
                                name: secret-prod
                                key: DATABASE_VISUALIZATION_HOST
                  ports:
                      - containerPort: 8084
                  resources:
                      requests:
                          memory: "64Mi" 
                          cpu: "20m"
                      limits:
                          memory: "128Mi"
                          cpu: "40m"
                  livenessProbe:
                      httpGet:
                          path: /api/visualization/liveness-check
                          port: 8084
                      initialDelaySeconds: 60
                      periodSeconds: 5
                  volumeMounts:
                      - name: secrets
                        mountPath: "/secrets"
                        readOnly: true
            volumes:
                - name: secrets
                  secret:
                      secretName: secret-prod
---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: authentication
    labels:
        app: authentication
spec:
    replicas: 1
    revisionHistoryLimit: 5
    selector:
        matchLabels:
            app: authentication
    strategy: 
        type: RollingUpdate
        rollingUpdate:
            maxSurge: 1
            maxUnavailable: 33%
    template:
        metadata:
            labels:
                app: authentication
        spec:
            containers:
                - name: authentication-container
                  image: alexandrefigueired0/authentication-container:latest
                  env:
                      - name: APP_SECRET_KEY
                        valueFrom:
                            secretKeyRef:
                                name: secret-prod
                                key: APP_SECRET_KEY
                      - name: AUTH0_DOMAIN
                        valueFrom:
                            secretKeyRef:
                                name: secret-prod
                                key: AUTH0_DOMAIN
                      - name: AUTH0_CLIENT_ID
                        valueFrom:
                            secretKeyRef:
                                name: secret-prod
                                key: AUTH0_CLIENT_ID
                      - name: AUTH0_CLIENT_SECRET
                        valueFrom:
                            secretKeyRef:
                                name: secret-prod
                                key: AUTH0_CLIENT_SECRET
                      - name: AUTH0_MANAGEMENT_TOKEN
                        value: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImdvdHFEMG9XSHNmamlhTjRfV0IyeiJ9.eyJpc3MiOiJodHRwczovL3RvbWFzYmFycmV0by5ldS5hdXRoMC5jb20vIiwic3ViIjoiRXZBNTgxSU9EZU5tS2RPeXFzSlZoWUhVSWtNTUQyZGlAY2xpZW50cyIsImF1ZCI6Imh0dHBzOi8vdG9tYXNiYXJyZXRvLmV1LmF1dGgwLmNvbS9hcGkvdjIvIiwiaWF0IjoxNzEzNzE4MDI5LCJleHAiOjE3MTYzMTAwMjksInNjb3BlIjoicmVhZDpjbGllbnRfZ3JhbnRzIGNyZWF0ZTpjbGllbnRfZ3JhbnRzIGRlbGV0ZTpjbGllbnRfZ3JhbnRzIHVwZGF0ZTpjbGllbnRfZ3JhbnRzIHJlYWQ6dXNlcnMgdXBkYXRlOnVzZXJzIGRlbGV0ZTp1c2VycyBjcmVhdGU6dXNlcnMgcmVhZDp1c2Vyc19hcHBfbWV0YWRhdGEgdXBkYXRlOnVzZXJzX2FwcF9tZXRhZGF0YSBkZWxldGU6dXNlcnNfYXBwX21ldGFkYXRhIGNyZWF0ZTp1c2Vyc19hcHBfbWV0YWRhdGEgcmVhZDp1c2VyX2N1c3RvbV9ibG9ja3MgY3JlYXRlOnVzZXJfY3VzdG9tX2Jsb2NrcyBkZWxldGU6dXNlcl9jdXN0b21fYmxvY2tzIGNyZWF0ZTp1c2VyX3RpY2tldHMgcmVhZDpjbGllbnRzIHVwZGF0ZTpjbGllbnRzIGRlbGV0ZTpjbGllbnRzIGNyZWF0ZTpjbGllbnRzIHJlYWQ6Y2xpZW50X2tleXMgdXBkYXRlOmNsaWVudF9rZXlzIGRlbGV0ZTpjbGllbnRfa2V5cyBjcmVhdGU6Y2xpZW50X2tleXMgcmVhZDpjb25uZWN0aW9ucyB1cGRhdGU6Y29ubmVjdGlvbnMgZGVsZXRlOmNvbm5lY3Rpb25zIGNyZWF0ZTpjb25uZWN0aW9ucyByZWFkOnJlc291cmNlX3NlcnZlcnMgdXBkYXRlOnJlc291cmNlX3NlcnZlcnMgZGVsZXRlOnJlc291cmNlX3NlcnZlcnMgY3JlYXRlOnJlc291cmNlX3NlcnZlcnMgcmVhZDpkZXZpY2VfY3JlZGVudGlhbHMgdXBkYXRlOmRldmljZV9jcmVkZW50aWFscyBkZWxldGU6ZGV2aWNlX2NyZWRlbnRpYWxzIGNyZWF0ZTpkZXZpY2VfY3JlZGVudGlhbHMgcmVhZDpydWxlcyB1cGRhdGU6cnVsZXMgZGVsZXRlOnJ1bGVzIGNyZWF0ZTpydWxlcyByZWFkOnJ1bGVzX2NvbmZpZ3MgdXBkYXRlOnJ1bGVzX2NvbmZpZ3MgZGVsZXRlOnJ1bGVzX2NvbmZpZ3MgcmVhZDpob29rcyB1cGRhdGU6aG9va3MgZGVsZXRlOmhvb2tzIGNyZWF0ZTpob29rcyByZWFkOmFjdGlvbnMgdXBkYXRlOmFjdGlvbnMgZGVsZXRlOmFjdGlvbnMgY3JlYXRlOmFjdGlvbnMgcmVhZDplbWFpbF9wcm92aWRlciB1cGRhdGU6ZW1haWxfcHJvdmlkZXIgZGVsZXRlOmVtYWlsX3Byb3ZpZGVyIGNyZWF0ZTplbWFpbF9wcm92aWRlciBibGFja2xpc3Q6dG9rZW5zIHJlYWQ6c3RhdHMgcmVhZDppbnNpZ2h0cyByZWFkOnRlbmFudF9zZXR0aW5ncyB1cGRhdGU6dGVuYW50X3NldHRpbmdzIHJlYWQ6bG9ncyByZWFkOmxvZ3NfdXNlcnMgcmVhZDpzaGllbGRzIGNyZWF0ZTpzaGllbGRzIHVwZGF0ZTpzaGllbGRzIGRlbGV0ZTpzaGllbGRzIHJlYWQ6YW5vbWFseV9ibG9ja3MgZGVsZXRlOmFub21hbHlfYmxvY2tzIHVwZGF0ZTp0cmlnZ2VycyByZWFkOnRyaWdnZXJzIHJlYWQ6Z3JhbnRzIGRlbGV0ZTpncmFudHMgcmVhZDpndWFyZGlhbl9mYWN0b3JzIHVwZGF0ZTpndWFyZGlhbl9mYWN0b3JzIHJlYWQ6Z3VhcmRpYW5fZW5yb2xsbWVudHMgZGVsZXRlOmd1YXJkaWFuX2Vucm9sbG1lbnRzIGNyZWF0ZTpndWFyZGlhbl9lbnJvbGxtZW50X3RpY2tldHMgcmVhZDp1c2VyX2lkcF90b2tlbnMgY3JlYXRlOnBhc3N3b3Jkc19jaGVja2luZ19qb2IgZGVsZXRlOnBhc3N3b3Jkc19jaGVja2luZ19qb2IgcmVhZDpjdXN0b21fZG9tYWlucyBkZWxldGU6Y3VzdG9tX2RvbWFpbnMgY3JlYXRlOmN1c3RvbV9kb21haW5zIHVwZGF0ZTpjdXN0b21fZG9tYWlucyByZWFkOmVtYWlsX3RlbXBsYXRlcyBjcmVhdGU6ZW1haWxfdGVtcGxhdGVzIHVwZGF0ZTplbWFpbF90ZW1wbGF0ZXMgcmVhZDptZmFfcG9saWNpZXMgdXBkYXRlOm1mYV9wb2xpY2llcyByZWFkOnJvbGVzIGNyZWF0ZTpyb2xlcyBkZWxldGU6cm9sZXMgdXBkYXRlOnJvbGVzIHJlYWQ6cHJvbXB0cyB1cGRhdGU6cHJvbXB0cyByZWFkOmJyYW5kaW5nIHVwZGF0ZTpicmFuZGluZyBkZWxldGU6YnJhbmRpbmcgcmVhZDpsb2dfc3RyZWFtcyBjcmVhdGU6bG9nX3N0cmVhbXMgZGVsZXRlOmxvZ19zdHJlYW1zIHVwZGF0ZTpsb2dfc3RyZWFtcyBjcmVhdGU6c2lnbmluZ19rZXlzIHJlYWQ6c2lnbmluZ19rZXlzIHVwZGF0ZTpzaWduaW5nX2tleXMgcmVhZDpsaW1pdHMgdXBkYXRlOmxpbWl0cyBjcmVhdGU6cm9sZV9tZW1iZXJzIHJlYWQ6cm9sZV9tZW1iZXJzIGRlbGV0ZTpyb2xlX21lbWJlcnMgcmVhZDplbnRpdGxlbWVudHMgcmVhZDphdHRhY2tfcHJvdGVjdGlvbiB1cGRhdGU6YXR0YWNrX3Byb3RlY3Rpb24gcmVhZDpvcmdhbml6YXRpb25zX3N1bW1hcnkgY3JlYXRlOmF1dGhlbnRpY2F0aW9uX21ldGhvZHMgcmVhZDphdXRoZW50aWNhdGlvbl9tZXRob2RzIHVwZGF0ZTphdXRoZW50aWNhdGlvbl9tZXRob2RzIGRlbGV0ZTphdXRoZW50aWNhdGlvbl9tZXRob2RzIHJlYWQ6b3JnYW5pemF0aW9ucyB1cGRhdGU6b3JnYW5pemF0aW9ucyBjcmVhdGU6b3JnYW5pemF0aW9ucyBkZWxldGU6b3JnYW5pemF0aW9ucyBjcmVhdGU6b3JnYW5pemF0aW9uX21lbWJlcnMgcmVhZDpvcmdhbml6YXRpb25fbWVtYmVycyBkZWxldGU6b3JnYW5pemF0aW9uX21lbWJlcnMgY3JlYXRlOm9yZ2FuaXphdGlvbl9jb25uZWN0aW9ucyByZWFkOm9yZ2FuaXphdGlvbl9jb25uZWN0aW9ucyB1cGRhdGU6b3JnYW5pemF0aW9uX2Nvbm5lY3Rpb25zIGRlbGV0ZTpvcmdhbml6YXRpb25fY29ubmVjdGlvbnMgY3JlYXRlOm9yZ2FuaXphdGlvbl9tZW1iZXJfcm9sZXMgcmVhZDpvcmdhbml6YXRpb25fbWVtYmVyX3JvbGVzIGRlbGV0ZTpvcmdhbml6YXRpb25fbWVtYmVyX3JvbGVzIGNyZWF0ZTpvcmdhbml6YXRpb25faW52aXRhdGlvbnMgcmVhZDpvcmdhbml6YXRpb25faW52aXRhdGlvbnMgZGVsZXRlOm9yZ2FuaXphdGlvbl9pbnZpdGF0aW9ucyBkZWxldGU6cGhvbmVfcHJvdmlkZXJzIGNyZWF0ZTpwaG9uZV9wcm92aWRlcnMgcmVhZDpwaG9uZV9wcm92aWRlcnMgdXBkYXRlOnBob25lX3Byb3ZpZGVycyBkZWxldGU6cGhvbmVfdGVtcGxhdGVzIGNyZWF0ZTpwaG9uZV90ZW1wbGF0ZXMgcmVhZDpwaG9uZV90ZW1wbGF0ZXMgdXBkYXRlOnBob25lX3RlbXBsYXRlcyBjcmVhdGU6ZW5jcnlwdGlvbl9rZXlzIHJlYWQ6ZW5jcnlwdGlvbl9rZXlzIHVwZGF0ZTplbmNyeXB0aW9uX2tleXMgZGVsZXRlOmVuY3J5cHRpb25fa2V5cyByZWFkOnNlc3Npb25zIGRlbGV0ZTpzZXNzaW9ucyByZWFkOnJlZnJlc2hfdG9rZW5zIGRlbGV0ZTpyZWZyZXNoX3Rva2VucyBjcmVhdGU6c2VsZl9zZXJ2aWNlX3Byb2ZpbGVzIHJlYWQ6c2VsZl9zZXJ2aWNlX3Byb2ZpbGVzIHVwZGF0ZTpzZWxmX3NlcnZpY2VfcHJvZmlsZXMgZGVsZXRlOnNlbGZfc2VydmljZV9wcm9maWxlcyBjcmVhdGU6c3NvX2FjY2Vzc190aWNrZXRzIHJlYWQ6Y2xpZW50X2NyZWRlbnRpYWxzIGNyZWF0ZTpjbGllbnRfY3JlZGVudGlhbHMgdXBkYXRlOmNsaWVudF9jcmVkZW50aWFscyBkZWxldGU6Y2xpZW50X2NyZWRlbnRpYWxzIiwiZ3R5IjoiY2xpZW50LWNyZWRlbnRpYWxzIiwiYXpwIjoiRXZBNTgxSU9EZU5tS2RPeXFzSlZoWUhVSWtNTUQyZGkifQ.CLNyqRf4RDMIet1HR4WebSvn6Vzu1LTiCL-MnrPcKdw9siqJLFdLaKdwce2__X4U4eyj8bvkAOvLBdYUViII3Ci-HPmc-Gr2TAeBIqOAV8c8CWmiW4N4MKOE13Vk-Z-6Kz5gJRn4nO1f-dUUgOqk_-2dX5TWZ2nMiA8vb4ULJBoapsTds6bDBb6u1XZkVLVAJ6GQAUvvwZ_FED2qWB1Jy85FFmQQIDpvj6O2PiQOJ4NlnQJdBXuC34N0pD5BU_wp2BrRHeVqE0938iJ9_G1xuTG9GPjVWXmB-oawPwLMNxizQVyQowyCWLkTbsAv_cXXfZDwoGB-jtRhPNiVr8WXpA
                  ports:
                      - containerPort: 8085
                  resources:
                      requests:
                          memory: "48Mi"
                          cpu: "100m"
                      limits:
                          memory: "64Mi"
                          cpu: "200m"
                  livenessProbe:
                      httpGet:
                          path: /api/authentication/liveness-check
                          port: 8085
                      initialDelaySeconds: 60
                      periodSeconds: 5
                  volumeMounts:
                      - name: secrets
                        mountPath: "/secrets"
                        readOnly: true
            volumes:
                - name: secrets
                  secret:
                      secretName: secret-prod
---
apiVersion: v1
kind: Service
metadata:
    name: database-ranking
spec:
    selector:
        app: database-ranking
    ports:
        - protocol: TCP
          port: 50052
          targetPort: 50052
---
apiVersion: v1
kind: Service
metadata:
    name: database-visualization
spec:
    selector:
        app: database-visualization
    ports:
        - protocol: TCP
          port: 50051
          targetPort: 50051
---
apiVersion: v1
kind: Service
metadata:
    name: forecast
spec:
    selector:
        app: forecast
    type: NodePort
    ports:
        - protocol: TCP
          port: 8080
          targetPort: 8080
---
apiVersion: v1
kind: Service
metadata:
    name: management
spec:
    selector:
        app: management
    type: NodePort
    ports:
        - protocol: TCP
          port: 8081
          targetPort: 8081
---
apiVersion: v1
kind: Service
metadata:
    name: ranking
spec:
    selector:
        app: ranking
    type: NodePort
    ports:
        - protocol: TCP
          port: 8082
          targetPort: 8082
---
apiVersion: v1
kind: Service
metadata:
    name: recommendations
spec:
    selector:
        app: recommendations
    type: NodePort
    ports:
        - protocol: TCP
          port: 8083
          targetPort: 8083
---
apiVersion: v1
kind: Service
metadata:
    name: visualization
spec:
    selector:
        app: visualization
    type: NodePort
    ports:
        - protocol: TCP
          port: 8084
          targetPort: 8084
---
apiVersion: v1
kind: Service
metadata:
    name: authentication
spec:
    selector:
        app: authentication
    ports:
        - protocol: TCP
          port: 8085
          targetPort: 8085
